<script type="text/javascript">
/**
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.

 * The Apereo Foundation licenses this file to you under the Apache License,
 * Version 2.0 (the "License"); you may not use this file except in
 * compliance with the License. You may obtain a copy of the License at:
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.

 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
	
	// pageChanged & sizeChanged functions are needed in every model file
	// other functions for model should also be in here to avoid conflicts
	var hotspotImage = new function() {
		var	$img;
		var amountOfAttempts = x_currentPageXML.getAttribute("attempts");
		var attempts = parseInt(amountOfAttempts, 10);
		var counter = [];
		var hits = [];
		var pointsUpdated = [];
		var canvas;
		var gotHint = false;
		var pointArray;
		// function called every time the page is viewed after it has initially loaded
		this.pageChanged = function() {
			$img = $("#image");
			
			$(".selected").removeClass("selected");
			$("#infoHolder").html("");
			$("#nextHS").button("enable");
			$("#prevHS").button("disable");
		};
		
		// function called every time the size of the LO is changed
		this.sizeChanged = function() {
			$img.css({
				"opacity"	:0,
				"filter"	:'alpha(opacity=0)'
			});
			this.resizeImg(false);

		};
		
		this.init = function() {
		    x_currentPageXML.childNodes.forEach(function () {
				hits.push(false);
				counter.push(0);
            });

			$img = $("#image");


            if (x_currentPageXML.getAttribute("align") == "Right") {
				$("#panel").addClass("left");
			} else {
				$("#panel").addClass("right");
			}
			$("#mainText").html(x_addLineBreaks(x_currentPageXML.getAttribute("text")));
			$img
				.css({
						"opacity"	:0,
						"filter"	:'alpha(opacity=0)'
				})
				.one("load", function() {
					hotspotImage.resizeImg(true);
					
					// call this function in every model once everything's loaded
					x_pageLoaded();
				})
				.attr({
					"src"	:x_evalURL(x_currentPageXML.getAttribute("url")),
					"alt"	:x_currentPageXML.getAttribute("tip")
				})
				.each(function() { // called if loaded from cache as in some browsers load won't automatically trigger
					if (this.complete) {
						$(this).trigger("load");
					}
				});
			
			if (x_currentPageXML.getAttribute("interactivity") == "Show Me") {
				// if language attributes aren't in xml will have to use english fall back
				var nextTxt = x_currentPageXML.getAttribute("nextTxt");
				if (nextTxt == undefined) {
					nextTxt = "Next";
				}
				var priorTxt = x_currentPageXML.getAttribute("priorTxt");
				if (priorTxt == undefined) {
					priorTxt = "Previous";
				}
				
				$("#nextHS")
					.button({
						icons: {
							primary: "fa fa-x-next"
						},
						label	:nextTxt,
						text	:false
					})
					.click(function() {

						hotspotImage.selectHs("next");
					});
				
				$("#prevHS")
					.button({
						icons: {
							primary: "fa fa-x-prev"
						},
						label		:priorTxt,
						text		:false,
						disabled	:true
					})
					.click(function() {
						hotspotImage.selectHs("prev");
					});
			} else { // click explore
				$("#pageContents button").remove();

			}
            this.selectHs("next");
		};

		this.resizeImg = function(firstLoad) {
			var imgMaxW = Math.round($x_pageHolder.width() * (400.0/800.0)),
				imgMaxH = Math.round($x_pageHolder.height() * (550.0/600.0) - 100);
			x_scaleImg($img, imgMaxW, imgMaxH, true, firstLoad, false);
			
			$img.css({
				"opacity"	:1,
				"filter"	:'alpha(opacity=100)'
			});

            $("canvas")[0].width = $("#image").width();
            $("canvas")[0].height = $("#image").height();
			this.createHS();

		}
		
		this.createHS = function() {
			// create hotspots - taking scale of image into account
			var scale = $img.width() / $img.data("origSize")[0],
				selected = $("#pageContents .hotspot.selected").length > 0 ? $("#pageContents .hotspot.selected").index() : undefined;
			$("#hsHolder").html("");
			
			$(x_currentPageXML).children()
				.each(function(i) {
					return;


                });
			var highlightColour = "yellow";
			if (x_currentPageXML.getAttribute("hicol") != undefined && x_currentPageXML.getAttribute("hicol") != "") {
				highlightColour = x_getColour(x_currentPageXML.getAttribute("hicol"));
			}
			$("#pageContents .hotspot").css("border-color", highlightColour);
			if (x_currentPageXML.getAttribute("highlight") == "true") {
				$("#pageContents .hotspot").addClass("highlightBorder");
			}
			
			if (selected != undefined) {
				$("#pageContents .hotspot:eq(" + selected + ")").trigger("click");
			}
		};


		this.selectHs = function(type) {

            var i = Number( $("canvas").attr("data-child-index"));
			pointsUpdated[i] = false;

            if (type === "next") {
                i +=1;

            } else {
                i-=1;
            }
            if(i > 0){
                $("#prevHS").button("enable");
			}else{
                $("#prevHS").button("disable");
			}

			if(i < counter.length-1){
                $("#nextHS").button("enable");
			}else{
                $("#nextHS").button("disable");
			}

            canvas = $("canvas")[0];

            var context = canvas.getContext('2d');
            context.clearRect(0, 0, canvas.width, canvas.height);

            var points = x_currentPageXML.children[i].getAttribute("points");
            origW = x_currentPageXML.children[i].getAttribute("w");
            origH = x_currentPageXML.children[i].getAttribute("h");
            pointArray = JSON.parse(points);

            if(!pointsUpdated[i] && pointArray != undefined){
                pointArray = pointArray.map(function (p) {
                    p.x = p.x * ($("canvas").width());
                    p.y = p.y * ($("canvas").height());
                    return p;
                });
                pointsUpdated[i] = true;
            }


            $("canvas").attr("data-child-index", i);

			if(counter[i] >= attempts || hits[i]){

                redraw_points(canvas, pointArray, hits[i]);

			}

            var $question = $("#questionText");
            var question = x_currentPageXML.childNodes[i].getAttribute("question");
            question = $("<div>").html(question).text().trim();
            $question.html(question);



          //  $("#nextHS").button("enable");
          //  $("#prevHS").button("disable");

            $("#hint").html("");
			$("#feedback").html("");
            if(x_currentPageXML.childNodes[i].getAttribute("hint") === null || x_currentPageXML.childNodes[i].getAttribute("hint") === ""){
                gotHint = true
			}else{
                gotHint = false;
			}

            var _this = this;

            $("canvas").off("click");
            $("canvas").on("click", function (event) {

                var i = Number( $("canvas").attr("data-child-index"));

                if(!pointsUpdated[i] && pointArray != undefined){
                    pointArray = pointArray.map(function (p) {
                        p.x = p.x * ($("canvas").width());
                        p.y = p.y * ($("canvas").height());
                        return p;
                    });
                    pointsUpdated[i] = true;
                }
				if(hits[i]){
                    return;
				}
				canvas = $(this)[0];
                var rect = this.getBoundingClientRect();
                var rect2 = $("canvas")[0].getBoundingClientRect();
                var x = event.clientX - rect.x;
                var y = event.clientY - rect.y;
                var CI = checkIntersection(x, y, pointArray);
                redraw_points(canvas, pointArray, CI);

                var i = Number( $("canvas").attr("data-child-index"));

                hits[i] = CI;

                var $hint = $("#hint");
                var $feedback = $("#feedback");
                var feedback = x_currentPageXML.childNodes[i].getAttribute("feedback");
                var hint = x_currentPageXML.childNodes[i].getAttribute("hint");
                feedback = $("<div>").html(feedback).text().trim();
                if (counter[i] <= attempts) {
                    if (CI) {
                        $feedback.append("<h3>" + "Feedback" + "</h3>");
                        $feedback.append(feedback);

                    } else {
                        if(gotHint === false){

							$hint.append( "<h3>" + "Hint" + "</h3>");
                            $hint.append(hint);
                            gotHint=true;
						}
                    }

                }


            });
            pointsUpdated[i]=false;
            var points = x_currentPageXML.children[i].getAttribute("points");
            origW = x_currentPageXML.children[i].getAttribute("w");
            origH = x_currentPageXML.children[i].getAttribute("h");
            pointArray = JSON.parse(points);


            checkIntersection = function (x, y, pointsArray) {
                // ray-casting algorithm based on
                // http://www.ecse.rpi.edu/Homepages/wrf/Research/Short_Notes/pnpoly.html


                var inside = false;

                for (var i = 0, j = pointsArray.length - 1; i < pointsArray.length; j = i++) {
                    var xi = pointsArray[i].x, yi = pointsArray[i].y;
                    var xj = pointsArray[j].x, yj = pointsArray[j].y;

                    var intersect = ((yi > y) !== (yj > y))
                        && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                    if (intersect) inside = !inside;
                }

                return inside;
            };

            function redraw_points(canvas, points, isHit) {
                var x = Number( $("canvas").attr("data-child-index"));
                counter[x] = Number(counter[x]+1);


                var context = canvas.getContext('2d');
                context.beginPath();
                context.lineWidth = 1;
                context.clearRect(0, 0, canvas.width, canvas.height);

                // context.setLineDash([5, 5]);

                var color = x_currentPageXML.getAttribute("hicol");
                color = color.replace("0x", "#");
                for (var i = 0; i < points.length + 1; i++) {
                    point = points[i % points.length];
                    if (i == 0) {
                        context.moveTo(point.x, point.y);
                    } else {
                        context.lineTo(point.x, point.y);
                    }
                }

                if (counter[x] >= attempts || isHit) {
                    context.strokeStyle = color;
                    context.fillStyle = color;
                    context.globalAlpha = 0.3;
                    context.fill();
                    context.globalAlpha = 1;
                    context.lineWidth = 2;
                    context.stroke();
                }

            }

        }
	};
	
	hotspotImage.init();
	
</script>



<div id="pageContents">

	<div id="panel" class="panel inline">
		<div id="questionText" class="right"/>
		<div id="imageHolder">
			<div class="overlayWrapper">
				<img id="image"/>
				<canvas class="canvas" data-child-index="-1"></canvas>
			</div>

			<div id="hsHolder"></div>
			<div id="btnHolder">
				<button id="prevHS"></button>
				<button id="nextHS"></button>
			</div>
			<div id="hint">

			</div>
			<div id="feedback">

			</div>
		</div>
	</div>
	
	<div id="textContents">
		<div id="mainText" tabindex="1"></div>
		<div id="infoHolder" class="right"></div>
	</div>
	
</div>
